<mxfile host="65bd71144e">
    <diagram name="Data Flow Architecture" id="data-flow">
        <mxGraphModel dx="1195" dy="1139" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1000" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="title" value="CNAB Parser API - Data Flow Architecture" style="fontSize=18;fontStyle=bold;align=center;fillColor=none;strokeColor=none;" parent="1" vertex="1">
                    <mxGeometry y="10" width="1400" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="client" value="ðŸ‘¤ Client (Browser)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FF;strokeColor=#01579B;strokeWidth=2;fontSize=12;fontStyle=bold;" parent="1" vertex="1">
                    <mxGeometry x="60" y="80" width="160" height="70" as="geometry"/>
                </mxCell>
                <mxCell id="arrow1" parent="1" source="client" target="controller" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="Xhdw3GE_v_z7tmCeaA4k-13" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-size: 9px;&quot;&gt;POST /api/v1/transactions/upload&lt;/span&gt;&lt;br style=&quot;color: rgb(63, 63, 63); scrollbar-color: rgb(226, 226, 226) rgb(251, 251, 251); font-size: 9px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0); font-size: 9px;&quot;&gt;multipart/form-data&lt;/span&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="arrow1" vertex="1" connectable="0">
                    <mxGeometry x="-0.3368" y="-2" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="apiContainer" value="ðŸ”· ASP.NET Core API" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#4A148C;strokeWidth=2;fontSize=12;fontStyle=bold;verticalAlign=bottom;" parent="1" vertex="1">
                    <mxGeometry x="445" y="60" width="420" height="200" as="geometry"/>
                </mxCell>
                <mxCell id="controller" value="TransactionsController" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FCE4EC;strokeColor=#880E4F;strokeWidth=1.5;fontSize=11;" parent="1" vertex="1">
                    <mxGeometry x="465" y="90" width="160" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="facade" value="TransactionFacadeService&#xa;âœ“ Validate file&#xa;âœ“ Check duplicates&#xa;âœ“ Store in MinIO&#xa;âœ“ Create record&#xa;âœ“ Enqueue to Redis" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FCE4EC;strokeColor=#880E4F;strokeWidth=1.5;fontSize=10;align=left;spacingLeft=5;" parent="1" vertex="1">
                    <mxGeometry x="665" y="80" width="170" height="110" as="geometry"/>
                </mxCell>
                <mxCell id="arrow2" parent="1" source="controller" target="facade" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="response" value="â†©ï¸ Return 202 Accepted&#xa;{status: processing}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=1.5;fontSize=10;" parent="1" vertex="1">
                    <mxGeometry x="465" y="160" width="160" height="70" as="geometry"/>
                </mxCell>
                <mxCell id="arrow3" parent="1" source="facade" target="response" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="65" y="20" as="sourcePoint"/>
                        <mxPoint x="65" y="20" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="minio" value="ðŸ—„ï¸ MinIO&#xa;(Storage)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E0F2F1;strokeColor=#004D40;strokeWidth=2;fontSize=11;fontStyle=bold;" parent="1" vertex="1">
                    <mxGeometry x="845" y="330" width="150" height="90" as="geometry"/>
                </mxCell>
                <mxCell id="redis" value="ðŸ”´ Redis&#xa;(Queue/Streams)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#B71C1C;strokeWidth=2;fontSize=11;fontStyle=bold;" parent="1" vertex="1">
                    <mxGeometry x="675" y="330" width="150" height="90" as="geometry"/>
                </mxCell>
                <mxCell id="arrow4" parent="1" source="facade" target="minio" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="715" y="190" as="sourcePoint"/>
                        <mxPoint x="240" y="320" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="Xhdw3GE_v_z7tmCeaA4k-11" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-size: 10px;&quot;&gt;Upload file&lt;/span&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="arrow4" vertex="1" connectable="0">
                    <mxGeometry x="0.3907" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="arrow5" parent="1" source="facade" target="redis" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="715" y="190" as="sourcePoint"/>
                        <mxPoint x="450" y="320" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="label5" value="Enqueue message" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;backgroundColor=#FFFACD;" parent="arrow5" vertex="1" connectable="0">
                    <mxGeometry x="20" y="-20" relative="1" as="geometry">
                        <mxPoint x="15" y="-1361" as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="workerContainer" value="ðŸ”„ Background Processing" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#1B5E20;strokeWidth=2;fontSize=12;fontStyle=bold;verticalAlign=bottom;" parent="1" vertex="1">
                    <mxGeometry x="695" y="510" width="540" height="220" as="geometry"/>
                </mxCell>
                <mxCell id="worker" value="UploadProcessingHostedService&#xa;âœ“ Dequeue message&#xa;âœ“ Acquire lock&#xa;âœ“ Download from MinIO&#xa;âœ“ Check checkpoint&#xa;âœ“ Process lines" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#1B5E20;strokeWidth=1.5;fontSize=10;align=left;spacingLeft=5;" parent="1" vertex="1">
                    <mxGeometry x="715" y="540" width="200" height="110" as="geometry"/>
                </mxCell>
                <mxCell id="lineProcessor" value="LineProcessor&#xa;âœ“ Validate line&#xa;âœ“ Parse CNAB&#xa;âœ“ Check duplicates&#xa;âœ“ Unit of Work (ACID)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#1B5E20;strokeWidth=1.5;fontSize=10;align=left;spacingLeft=5;" parent="1" vertex="1">
                    <mxGeometry x="1025" y="540" width="190" height="110" as="geometry"/>
                </mxCell>
                <mxCell id="arrow6" parent="1" source="redis" target="worker" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="450" y="410" as="sourcePoint"/>
                        <mxPoint x="465" y="550" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="arrow7" parent="1" source="worker" target="lineProcessor" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxGeometry as="geometry"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="Xhdw3GE_v_z7tmCeaA4k-12" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-size: 10px;&quot;&gt;Parallel Workers&lt;/span&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];labelBackgroundColor=default;" parent="arrow7" vertex="1" connectable="0">
                    <mxGeometry x="-0.0128" y="1" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="postgres" value="ðŸ—„ï¸ PostgreSQL&#xa;(Persistence)&#xa;- Transactions&#xa;- FileUploads&#xa;- LineHashes&#xa;- Users" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#0D47A1;strokeWidth=2;fontSize=11;fontStyle=bold;" parent="1" vertex="1">
                    <mxGeometry x="1025" y="820" width="200" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="arrow8" parent="1" source="lineProcessor" target="postgres" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="690" y="660" as="sourcePoint"/>
                        <mxPoint x="685" y="820" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="arrow9" parent="1" source="worker" target="minio" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="365" y="585" as="sourcePoint"/>
                        <mxPoint x="240" y="410" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="legend" value="ðŸ“Š Legend: ðŸ”· Service | ðŸ—„ï¸ Database | ðŸ”´ Cache | ðŸ‘¤ User | ðŸ”„ Worker | â†©ï¸ Response" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=italic;" parent="1" vertex="1">
                    <mxGeometry x="200" y="485" width="800" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="Xhdw3GE_v_z7tmCeaA4k-4" value="Download file" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;backgroundColor=#FFFACD;" parent="1" vertex="1" connectable="0">
                    <mxGeometry x="875.0002236784824" y="470.0041648924516" as="geometry"/>
                </mxCell>
                <mxCell id="Xhdw3GE_v_z7tmCeaA4k-9" value="Denqueue message" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;backgroundColor=#FFFACD;" parent="1" vertex="1" connectable="0">
                    <mxGeometry x="765" y="470.0066666666668" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
    <diagram name="CNAB Processing Flow" id="processing-flow">
        <mxGraphModel dx="1195" dy="1139" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2400" pageHeight="1600" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="title" value="CNAB File Upload &amp; Processing Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1" parent="1" vertex="1">
                    <mxGeometry x="860" y="227" width="600" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="phase1-box" value="Phase 1: Upload &amp; Validation (Synchronous)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;verticalAlign=top;spacingTop=10" parent="1" vertex="1">
                    <mxGeometry x="150" y="267" width="500" height="300" as="geometry"/>
                </mxCell>
                <mxCell id="step1" value="1. Client sends POST /api/v1/transactions/upload&#xa;   multipart/form-data with CNAB file" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="phase1-box" vertex="1">
                    <mxGeometry x="20" y="30" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="step2" value="2. TransactionsController.UploadCnabFile()&#xa;   â†’ TransactionFacadeService.UploadCnabFileAsync()" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="phase1-box" vertex="1">
                    <mxGeometry x="20" y="80" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="step3" value="3. FileUploadService.ReadCnabFileFromMultipartAsync()&#xa;   â€¢ Validate file format (80 chars per line)&#xa;   â€¢ Check file size limits" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="phase1-box" vertex="1">
                    <mxGeometry x="20" y="130" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step4" value="4. HashService.ComputeFileHash()&#xa;   â€¢ Calculate SHA256 hash of file content" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="phase1-box" vertex="1">
                    <mxGeometry x="20" y="190" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="step5" value="5. FileUploadTrackingService.IsFileUniqueAsync()&#xa;   â€¢ Check for duplicate file (by hash)&#xa;   â€¢ Return 409 Conflict if duplicate" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="phase1-box" vertex="1">
                    <mxGeometry x="20" y="240" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="phase2-box" value="Phase 2: Storage &amp; Queue (Synchronous)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontStyle=1;verticalAlign=top;spacingTop=10;container=0;" parent="1" vertex="1">
                    <mxGeometry x="150" y="670" width="500" height="303" as="geometry"/>
                </mxCell>
                <mxCell id="phase3-box" value="Phase 3: Background Processing (Asynchronous)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;verticalAlign=top;spacingTop=10;container=0;" parent="1" vertex="1">
                    <mxGeometry x="750" y="600" width="600" height="890" as="geometry"/>
                </mxCell>
                <mxCell id="phase4-box" value="Phase 4: Automatic Recovery (Background)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;verticalAlign=top;spacingTop=10" parent="1" vertex="1">
                    <mxGeometry x="1840" y="1130" width="500" height="280" as="geometry"/>
                </mxCell>
                <mxCell id="step21" value="21. IncompleteUploadRecoveryService (runs every 5 min)&#xa;    â€¢ Find uploads with Status=Processing&#xa;    â€¢ AND LastCheckpointAt &gt; 30 minutes ago" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="phase4-box" vertex="1">
                    <mxGeometry x="20" y="30" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step22" value="22. Check if upload is locked&#xa;    â€¢ RedisDistributedLockService.LockExistsAsync()&#xa;    â€¢ Skip if another worker is processing" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="phase4-box" vertex="1">
                    <mxGeometry x="20" y="90" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step23" value="23. Re-enqueue incomplete uploads&#xa;    â€¢ RedisUploadQueueService.EnqueueUploadAsync()&#xa;    â€¢ Processing resumes from LastCheckpointLine" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="phase4-box" vertex="1">
                    <mxGeometry x="20" y="150" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step24" value="24. Log recovery statistics&#xa;    â€¢ Number of uploads recovered&#xa;    â€¢ Errors encountered" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="phase4-box" vertex="1">
                    <mxGeometry x="20" y="210" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="error-box" value="Error Handling &amp; Retry Logic" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1;verticalAlign=top;spacingTop=10;container=0;" parent="1" vertex="1">
                    <mxGeometry x="1350" y="767" width="500" height="343" as="geometry"/>
                </mxCell>
                <mxCell id="arrow1" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#666666" parent="1" source="phase1-box" target="phase2-box" edge="1">
                    <mxGeometry width="50" height="50" relative="1" as="geometry">
                        <mxPoint x="660" y="457" as="sourcePoint"/>
                        <mxPoint x="710" y="407" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="7" value="&lt;span style=&quot;color: rgb(102, 102, 102); font-size: 12px; font-weight: 700; text-wrap-mode: wrap; background-color: rgb(251, 251, 251);&quot;&gt;Validated&lt;/span&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="arrow1" vertex="1" connectable="0">
                    <mxGeometry x="0.04" y="4" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="arrow2" value="" style="endArrow=classic;html=1;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#666666" parent="1" source="phase2-box" target="phase3-box" edge="1">
                    <mxGeometry width="50" height="50" relative="1" as="geometry">
                        <mxPoint x="660" y="787" as="sourcePoint"/>
                        <mxPoint x="710" y="737" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="8" value="&lt;span style=&quot;color: rgb(102, 102, 102); font-size: 12px; font-weight: 700; text-wrap-mode: wrap; background-color: rgb(251, 251, 251);&quot;&gt;Queued&lt;/span&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="arrow2" vertex="1" connectable="0">
                    <mxGeometry x="-0.162" y="-4" relative="1" as="geometry">
                        <mxPoint y="-1" as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="arrow3" value="" style="endArrow=classic;html=1;rounded=0;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#666666" parent="1" source="phase3-box" target="phase4-box" edge="1">
                    <mxGeometry width="50" height="50" relative="1" as="geometry">
                        <mxPoint x="1360" y="617" as="sourcePoint"/>
                        <mxPoint x="1410" y="567" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="9" value="&lt;span style=&quot;color: rgb(102, 102, 102); font-size: 12px; font-weight: 700; text-wrap-mode: wrap; background-color: rgb(251, 251, 251);&quot;&gt;Recovery&lt;/span&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="arrow3" vertex="1" connectable="0">
                    <mxGeometry x="0.2665" y="3" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step10" value="10. UploadProcessingHostedService (Background Worker)&#xa;    â€¢ Polls Redis Streams for new messages&#xa;    â€¢ Uses Consumer Group pattern for distributed processing" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="647" width="560" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step11" value="11. RedisUploadQueueService.DequeueUploadAsync()&#xa;    â€¢ Read message from stream using consumer group&#xa;    â€¢ Returns: (messageId, uploadId, storagePath)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="707" width="560" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step12" value="12. RedisDistributedLockService.ExecuteWithLockAsync()&#xa;    â€¢ Acquire distributed lock: upload:processing:{uploadId}&#xa;    â€¢ Prevents concurrent processing by multiple workers" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="767" width="560" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step13" value="13. FileUploadTrackingService.UpdateProcessingStatusAsync()&#xa;    â€¢ Update FileUpload.Status: Pending â†’ Processing" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="827" width="560" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="step14" value="14. MinioStorageService.DownloadFileAsync()&#xa;    â€¢ Download file content from MinIO using storagePath" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="877" width="560" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="step15" value="15. Check for checkpoint (resume support)&#xa;    â€¢ FileUpload.LastCheckpointLine&#xa;    â€¢ If &gt; 0, resume from that line index" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="927" width="560" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step16" value="16. CnabUploadService.ProcessCnabUploadAsync()&#xa;    â€¢ Split file into lines&#xa;    â€¢ Process lines in parallel (ParallelWorkers config)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="987" width="560" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step17-box" value="For each line:" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="790" y="1050" width="520" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="step17a" value="17a. LineProcessor.ProcessLineAsync()&#xa;     â€¢ Validate line format (80 chars)&#xa;     â€¢ CnabParserService.ParseCnabLine()&#xa;     â€¢ Generate idempotencyKey = SHA256(fileHash + lineIndex)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="790" y="1090" width="520" height="70" as="geometry"/>
                </mxCell>
                <mxCell id="step17b" value="17b. Check for duplicate line&#xa;     â€¢ FileUploadTrackingService.IsLineHashUniqueAsync()" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="790" y="1170" width="520" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="step17c" value="17c. UnitOfWork.ExecuteInTransactionAsync() (ACID)&#xa;     â€¢ TransactionService.AddTransactionToContextAsync()&#xa;     â€¢ FileUploadTrackingService.CommitLineHashAsync()&#xa;     â€¢ SaveChanges() - atomic commit" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="790" y="1220" width="520" height="70" as="geometry"/>
                </mxCell>
                <mxCell id="step18" value="18. CheckpointManager.SaveCheckpointAsync() (periodic)&#xa;    â€¢ Save LastCheckpointLine every N lines (CheckpointInterval)&#xa;    â€¢ Enables resume on failure" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="1300" width="560" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step19" value="19. FileUploadTrackingService.UpdateProcessingSuccessAsync()&#xa;    â€¢ Update Status: Processing â†’ Success&#xa;    â€¢ Store: processedLineCount, failedLineCount, skippedLineCount" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="1355" width="560" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step20" value="20. RedisUploadQueueService.AcknowledgeMessageAsync()&#xa;    â€¢ Mark message as processed in consumer group" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="770" y="1410" width="560" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="step6" value="6. MinioStorageService.UploadFileAsync()&#xa;   â€¢ Store file in MinIO object storage&#xa;   â€¢ Returns storage path (e.g., cnab-20251229-100000.txt)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="170" y="710" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step7" value="7. FileUploadTrackingService.RecordPendingUploadAsync()&#xa;   â€¢ Create FileUpload record in PostgreSQL&#xa;   â€¢ Status: Pending&#xa;   â€¢ Store: fileHash, fileName, fileSize, storagePath" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="170" y="770" width="460" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="step8" value="8. RedisUploadQueueService.EnqueueUploadAsync()&#xa;   â€¢ Add message to Redis Stream: cnab:upload:queue&#xa;   â€¢ Message contains: uploadId, storagePath" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="170" y="840" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step9" value="9. Return 202 Accepted to client&#xa;   { message: &quot;File accepted and queued&quot;, status: &quot;processing&quot; }" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="170" y="900" width="460" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="error1" value="â€¢ Retry Logic: 3 attempts with exponential backoff&#xa;  (1s, 2s, 4s delays)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="1370" y="797" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="error2" value="â€¢ Dead Letter Queue: Failed messages after max retries&#xa;  moved to cnab:upload:dlq stream" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="1370" y="847" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="error3" value="â€¢ Graceful Degradation: MinIO failures don&#39;t block uploads&#xa;  File processing continues without storage backup" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="1370" y="897" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="error4" value="â€¢ Idempotency: Duplicate lines/transactions automatically skipped&#xa;  Based on SHA256(fileHash + lineIndex)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="1370" y="947" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="error5" value="â€¢ Checkpoint Support: Large files can resume from last checkpoint&#xa;  Prevents re-processing on failure/recovery" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="1370" y="997" width="460" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="error6" value="â€¢ Distributed Locks: Prevent concurrent processing&#xa;  Multiple API instances can process different uploads safely" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=10" parent="1" vertex="1">
                    <mxGeometry x="1370" y="1047" width="460" height="40" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>